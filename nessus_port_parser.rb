# Ornek girdi: ruby path/to/nessus_port_parser.rb nessus_csv_file.csv [syn, tcp, udp]
# Beklenen cikti: - Komut satirinda [IP]#port, port
#                 - Ayni dizinde nessus_csv_file_OpenPortsList.json adinda, json ciktisinin kaydedildigi dosya
#
# Ipucu: Portlardan once # karakterinin koyulma sebebi Excel'de sutunlama ayraci olarak(seperator) kullanilmasi icindir.
#
# TODO: IP listelerinin siralamasinda sorun var.
#       Tanimlanmayan tarama tipinde dosyaya cikti bos uretiliyor. Tanimlanmayan tarama tipi geldiginde betik calismamali.

# 2016-03-29
# Salih Ozdemir


require 'csv'
require 'json'

file_name = ARGV[0].to_s
csv = CSV.read(file_name)
result = Hash.new { |key, value| key[value] = [] }

case ARGV[1]
when 'syn'
  scan_type = '11219'
when 'udp'
  scan_type = '34277'
when 'tcp'
  scan_type = '10335'
else
  puts "Tarama tipi anlasilmadi. Sunlardan birini deneyin: syn, udp, tcp"
end

csv.each do |line|
  if line[0] == scan_type
    next if line[6] == '0'
    result[:"#{line[4]}"] << line[6].to_i
  end
end

result = result.sort_by { |key, _| key }
result.each do |_, value|
  value.sort!
end

result.each do |key|
  print key[0]
  print '#'
  values = ''
  key[1].each do |value|
    values = values.to_s + ', ' + value.to_s
  end
  values[0..1] = ''
  puts values
end

File.write("#{file_name}_OpenPortsList.json", result.to_json)
