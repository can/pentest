#Usage:
#1-Create a directory to collect nesses result files
#2-Export all results with nessus extension ( Export - Nessus ), save them into the dir. created in step 1
#3-Copy nessus_merger.py file located in /root/tool/ in to created dir.
#4-Edit nessus_merger.py ( report.attrib['name'] = 'Merged Report' ) * optional
#5-Import merged report to Nessus

import xml.etree.ElementTree as etree
import shutil
import os
 
first = 1
for fileName in os.listdir("."):
   if ".nessus" in fileName:
      print(":: Parsing", fileName)
      if first:
         mainTree = etree.parse(fileName)
         report = mainTree.find('Report')
         report.attrib['name'] = 'XXX-Report-Merged'
         first = 0
      else:
         tree = etree.parse(fileName)
         for host in tree.findall('.//ReportHost'):
            existing_host = report.find(".//ReportHost[@name='"+host.attrib['name']+"']")
            if not existing_host:
                print "adding host: " + host.attrib['name']
                report.append(host)
            else:
                for item in host.findall('ReportItem'):
                    if not existing_host.find("ReportItem[@port='"+ item.attrib['port'] +"'][@pluginID='"+ item.attrib['pluginID'] +"']"):
                        print "adding finding: " + item.attrib['port'] + ":" + item.attrib['pluginID']
                        existing_host.append(item)
      print(":: => done.")    
   
#if "nss_report" in os.listdir("."):
#   shutil.rmtree("nss_report")
   
#os.mkdir("nss_report")
mainTree.write("report.nessus", encoding="utf-8", xml_declaration=True)
